# Описание протокола

## Основные характеристики

- Длина отправляемых сообщений: 8 байт
- Информация о типе сообщения содержится в первом байте
- Порядок байтов – от младшего к старшему (little-endian)

## Сообщение о сбросе

### Описание

Содержит полное значение счётчика (32 бита), а также версию аппаратного и
программного обеспечения модема.

### Структура

| Байт | Описание |
|---|---|
| 1 | Подпись - `0x41` |
| 2..5 | Значение счётчика |
| 6 | Версия железа |
| 7 | Версия ПО |
| 8 | CRC времени компиляции |

#### Пример

```example
414B2FE73B0153D3

// подпись: сброс
0x41

// полное (32 бита) значение счётчика: 1005006667
0x3BE72F4B

// версия железа: 1
0x01

// версия прошивки: 83
0x53

// CRC времени компиляции: 211
0xD3
```

## Сообщение об ошибке

### Описание

Отправляется при возникновении ошибки.

### Структура

| Байт | Описание |
|---|---|
| 1 | Подпись - `0xA1` |
| 2..5 | Код ошибки |
| 6 | Версия железа |
| 7 | Версия ПО |
| 8 | CRC времени компиляции |

#### Пример

```example
A1630000000230E1

// подпись: ошибка
0xA1

// код ошибки
0x63

// версия железа: 2
0x02

// версия прошивки: 48
0x30

// CRC времени компиляции: 225
0xE1
```

## Ежемесячное сообщение

### Описание

Содержит полное значение счётчика (32 бита), общее количество отправленных
сообщений за все время работы модема, уровень мощности радиосигнала и
максимально зафиксированный расход.

### Структура

| Байт | Описание |
|---|---|
| 1 | Подпись - `0x61` |
| 2..5 | Полное значение 32-битного счётчика |
| 6-7 | Количество отправленных сообщений |
| 8 | Метаданные |

#### Метаданные

- Старшие 2 бита – уровень мощности сигнала
- Младшие 6 бит – максимально зафиксированное с момента калибровки  модема
- количество импульсов за одну минуту

#### Пример

```example
696543210063D39A

// подпись: ежемесячное, канал 2
0x69

// полное (32 бита) значение счётчика: 2179941
0x214365

// количество отправленных сообщений: 54115
0xD363

// уровень мощности сигнала: 2
0x9A >> 6 = 2

// максимальный расход: 26
0x9A & 0x3F = 0x1A
```

## Ежедневное сообщение

Cодержит младшие 15 бит счётчика импульсов и значения почасового расхода за 24
часа (первый час суток записан в двух старших битах последнего байта сообщения).

### Подпись

Первый байт имеет вид 0bXXXXXXX0, т.е. младший бит = 0.

### Структура

#### Байт 1

Бит 0 (младший бит) всегда 0, биты 1-7 - содержат первые 7 из бит значения
счётчика:

| MSB |    |    |    |    |    |    | LSB   |
|:---:|----|----|----|----|----|----|:-----:|
| b6  | b5 | b4 | b3 | b2 | b1 | b0 | **0** |

#### Байт 2

Содержит биты 7-14 значения счётчика:

| MSB |     |     |     |     |    |    | LSB |
|:---:|-----|-----|-----|-----|----|----|:---:|
| b14 | b13 | b12 | b11 | b10 | b9 | b8 | b7  |

#### Байты 3-8

48-битная маска почасового потребления – по 2 бита на час, обозначающая долю в
процентах от максимального часового расхода за сутки.

| Значение | Расход |
|---|---|
| 0 | Нет расхода |
| 1 | 0.1 - 33.3% |
| 2 | 33.4 - 66.6% |
| 3 | 66.7 - 100% |

#### Пример

```example
3419240004F04724

// подпись (младший бит = 0): ежедневное
0x34 = 00110100b

// 15 бит счётчика: 3226
0x1934 >> 1 = 0xC9A

// потребление по часам (0-23):
0x24 = 00100100b // 0, 2, 1, 0
0x47 = 01000111b // 1, 0, 1, 3
0xF0 = 11110000b // 3, 3, 0, 0
0x04 = 00000100b // 0, 0, 1, 0
0x00 = 00000000b // 0, 0, 0, 0
0x24 = 00100100b // 0, 2, 1, 0
```